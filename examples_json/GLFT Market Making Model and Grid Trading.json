[
  {
    "index": 0,
    "source": [
      "# Guéant–Lehalle–Fernandez-Tapia Market Making Model and Grid Trading"
    ]
  },
  {
    "index": 1,
    "source": [
      "## 概要\n",
      "\n",
      "グリッドトレーディングはシンプルで理解しやすく、高頻度環境で優れています。しかし、高頻度取引の複雑さを考えると、理想的なスプレッド、注文間隔、スキューを最適化することは困難です。さらに、これらの値は市場の状況に応じて変動するため、固定された設定は最適ではありません。\n",
      "\n",
      "グリッドトレーディングの適応性を向上させるための1つの解決策は、よく開発されたマーケットメイキングモデルと組み合わせることです。これがどのように実現できるかを見てみましょう。"
    ]
  },
  {
    "index": 2,
    "source": [
      "## Guéant–Lehalle–Fernandez-Tapia マーケットメイキングモデル\n",
      "\n",
      "このモデルは、よく知られたアベラネダ・ストイコビッチモデルの進化形であり、終端時間Tの漸近的な挙動の閉形式近似を提供します。簡単に言えば、このモデルは終端時間を指定しないため、典型的な株式、スポット資産、または暗号通貨の永久契約に適しています。このモデルを使用することで、市場の状況に応じてハーフスプレッドとスキューが正確に調整されることが期待されます。\n",
      "\n",
      "この分析では、[Optimal market making](https://arxiv.org/abs/1605.01862) の式(4.6)と(4.7)に焦点を当て、それらが実際のシナリオにどのように適用できるかを探ります。\n",
      "\n",
      "最適なビッドクォート深度 $\\delta^{b*}_{approx}$ とアスククォート深度 $\\delta^{a*}_{approx}$ は、公正価格から次のように導出されます:\n",
      "\n",
      "\\begin{align}\n",
      "\\delta^{b*}_{approx}(q) = {1 \\over {\\xi \\Delta}}log(1 + {\\xi \\Delta \\over k}) + {{2q + \\Delta} \\over 2}\\sqrt{{{\\gamma \\sigma^2} \\over {2A\\Delta k}}(1 + {\\xi \\Delta \\over k})^{{k \\over {\\xi \\Delta}} + 1}} \\label{eq4.6}\\tag{4.6} \\\\\n",
      "\\delta^{a*}_{approx}(q) = {1 \\over {\\xi \\Delta}}log(1 + {\\xi \\Delta \\over k}) - {{2q - \\Delta} \\over 2}\\sqrt{{{\\gamma \\sigma^2} \\over {2A\\Delta k}}(1 + {\\xi \\Delta \\over k})^{{k \\over {\\xi \\Delta}} + 1}} \\label{eq4.7}\\tag{4.7}\n",
      "\\end{align}\n",
      "\n",
      "次に、$c_1$ と $c_2$ を導入し、平方根からボラティリティ 𝜎 を抽出して定義します:\n",
      "\n",
      "\\begin{align}\n",
      "c_1 = {1 \\over {\\xi \\Delta}}log(1 + {\\xi \\Delta \\over k}) \\\\\n",
      "c_2 = \\sqrt{{\\gamma \\over {2A\\Delta k}}(1 + {\\xi \\Delta \\over k})^{{k \\over {\\xi \\Delta}} + 1}}\n",
      "\\end{align}\n",
      "\n",
      "これで、式(4.6)と(4.7)を次のように書き換えることができます:\n",
      "\n",
      "\\begin{align}\n",
      "\\delta^{b*}_{approx}(q) = c_1 + {\\Delta \\over 2} \\sigma c_2 + q \\sigma c_2 \\\\\n",
      "\\delta^{a*}_{approx}(q) = c_1 + {\\Delta \\over 2} \\sigma c_2 - q \\sigma c_2\n",
      "\\end{align}\n",
      "\n",
      "ご覧のとおり、これはハーフスプレッドとスキューで構成されています。$q$ はマーケットメイカーの在庫（ポジション）を表します。\n",
      "\n",
      "\\begin{align}\n",
      "\\text{half spread} = C_1 + {\\Delta \\over 2} \\sigma C_2 \\\\\n",
      "\\text{skew} = \\sigma C_2 \\\\\n",
      "\\delta^{b*}_{approx}(q) = \\text{half spread} + \\text{skew} \\times q \\\\\n",
      "\\delta^{a*}_{approx}(q) = \\text{half spread} - \\text{skew} \\times q\n",
      "\\end{align}\n",
      "\n",
      "したがって、\n",
      "\n",
      "\\begin{align}\n",
      "\\text{bid price} = \\text{fair price} - (\\text{half spread} + \\text{skew} \\times q) \\\\\n",
      "\\text{ask price} = \\text{fair price} + (\\text{half spread} - \\text{skew} \\times q)\n",
      "\\end{align}\n",
      "\n",
      "次の2つの記事に記載されている内容に類似点が見られます。  \n",
      "[Stochastic Control Theory and High Frequency Trading](https://ieor.columbia.edu/files/seasdepts/industrial-engineering-operations-research/pdf-files/Borden_D_FESeminar_Sp10.pdf)  \n",
      "[How to Market Make Bitcoin Derivatives Lesson 2](https://blog.bitmex.com/how-to-market-make-bitcoin-derivatives-lesson-2/)  "
    ]
  },
  {
    "index": 3,
    "source": [
      "## 取引強度の計算\n",
      "\n",
      "最適なクォートを決定するためには、$c_1$ と $c_2$ を計算する必要があります。そのためには、取引強度の $A$ と $k$ をキャリブレーションし、市場のボラティリティ $\\sigma$ を計算する必要があります。\n",
      "\n",
      "取引強度は次のように定義されます:\n",
      "\n",
      "$$ \\lambda = A \\exp (-k \\delta) $$\n",
      "\n",
      "これらの値を市場データを使用してキャリブレーションします。詳細は[この記事](https://quant.stackexchange.com/questions/36073/how-does-one-calibrate-lambda-in-a-avellaneda-stoikov-market-making-problem)をご覧ください。そのためには、市場注文の到着を記録する必要があります。\n",
      "\n",
      "私たちのマーケットメイカーは100msごとに反応し、この間隔で注文を投稿またはキャンセルします。したがって、クォートの取引強度も同じタイムステップで測定されます。理想的には、注文のキュー位置も考慮する必要がありますが、この分析では問題を単純化するために注文キュー位置は考慮しません。"
    ]
  },
  {
    "index": 5,
    "source": [
      "取引強度を測定する際に注文のキュー位置を考慮しないため、クォートをクロスする市場取引のみが実行されたと見なされます。"
    ]
  },
  {
    "index": 7,
    "source": [
      "HftBacktestを実行して市場を再生し、注文到着深度と価格変動を記録します。"
    ]
  },
  {
    "index": 9,
    "source": [
      "記録された注文到着深度から取引強度を測定し、プロットします。"
    ]
  },
  {
    "index": 12,
    "source": [
      "線形回帰を使用して $A$ と $k$ をキャリブレーションします。両辺の対数を取ると、$log \\lambda = -k \\delta + logA$ となります。"
    ]
  },
  {
    "index": 16,
    "source": [
      "ご覧のとおり、フィットされたラムダ関数は全範囲で正確ではありません。特に、ミッドプライスに近い浅い範囲では取引強度を過大評価し、ミッドプライスから離れた深い範囲では過小評価します。\n",
      "\n",
      "私たちのクォートは、少なくとも典型的な市場条件下（高ボラティリティ条件を除く）では、ミッドプライスに近い範囲に配置される可能性が高いため、特に最も近い範囲に対して関数を再フィットします。"
    ]
  },
  {
    "index": 19,
    "source": [
      "これで、より正確な取引強度関数が得られました。次に、クォートがどこに配置されるかを見てみましょう。\n",
      "\n",
      "その前に、まずボラティリティを計算しましょう。"
    ]
  },
  {
    "index": 21,
    "source": [
      "式に従って $c_1$ と $c_2$ を計算します。"
    ]
  },
  {
    "index": 23,
    "source": [
      "Guéant–Lehalle–Fernandez-Tapia の式では、$\\Delta = 1$ および $\\xi = \\gamma$ です。$\\gamma$ の値は任意に選択されます。"
    ]
  },
  {
    "index": 25,
    "source": [
      "クォートがミッドプライスから20ティック離れている場合、それは何を意味しますか？記録された注文到着深度を分析することで、マーケットメイカーとして参加する市場取引の数を特定できます。これは数量ではなくカウントで測定されます。また、スキューが非常に強いことがわかります。2つのポジションを積み上げるだけで、全体のハーフスプレッドがオフセットされます。"
    ]
  },
  {
    "index": 27,
    "source": [
      "特定のタイムステップごとに市場取引の約1.86％がクォートを実行する可能性があります。これは取引数量の割合ではないことに注意してください。"
    ]
  },
  {
    "index": 28,
    "source": [
      "## モデルを使用したマーケットメイカーの実装\n",
      "\n",
      "\n",
      "<div class=\"alert alert-info\">\n",
      "    \n",
      "**注:** この例は教育目的のみであり、高頻度マーケットメイキングスキームの効果的な戦略を示しています。すべてのバックテストは、Binance Futuresで利用可能な最高のマーケットメイカーリベートである0.005％のリベートに基づいています。詳細については、<a href=\"https://www.binance.com/en/support/announcement/binance-updates-usd%E2%93%A2-margined-futures-liquidity-provider-program-2024-06-03-fefc6aa25e0947e2bf745c1c56bea13e\">Binance Upgrades USDⓢ-Margined Futures Liquidity Provider Program</a> を参照してください。\n",
      "    \n",
      "</div>\n",
      "\n",
      "この例では、予測項を無視し、公正価格がミッドプライスと等しいと仮定します。短期的には内在価値が安定していると予想されるためです。"
    ]
  },
  {
    "index": 33,
    "source": [
      "## 調整係数\n",
      "\n",
      "スキューが強すぎるように見えるため、マーケットメイカーはポジションを取ることに消極的です。スキューを緩和するために、計算されたハーフスプレッドとスキューに調整係数 $adj_1$ と $adj_2$ を導入します。\n",
      "\n",
      "$$\n",
      "\\text{half spread}_{adj} = \\text{half spread} \\times adj_1 \\\\\n",
      "\\text{skew}_{adj} = \\text{skew} \\times adj_2\n",
      "$$"
    ]
  },
  {
    "index": 37,
    "source": [
      "改善されましたが、リベートを考慮しても、せいぜい損益分岐点に達するだけです。以下に示すように、ハーフスプレッドとスキューは主に $c_2$ と市場のボラティリティに影響されて一緒に動きます。"
    ]
  },
  {
    "index": 40,
    "source": [
      "5日間のバックテストでは、クォートを継続的に投稿することで高い取引量を維持し、リベートを通じて利益を上げていることが明らかです。"
    ]
  },
  {
    "index": 43,
    "source": [
      "## グリッドトレーディングの統合\n",
      "\n",
      "Guéant–Lehalle–Fernandez-Tapia マーケットメイキングモデルから導出されたビッド価格とアスク価格からグリッドを作成します。"
    ]
  },
  {
    "index": 47,
    "source": [
      "他のコインでもうまく機能することがわかります。次の例では、複数の市場を作成してリスク調整後のリターンを向上させる方法を示します。"
    ]
  },
  {
    "index": 50,
    "source": [
      "## まとめ\n",
      "\n",
      "これまでに、モデルを実際の例に適用する方法を示しました。\n",
      "\n",
      "より効果的なマーケットメイキングアルゴリズムを考える際には、このモデルを次のカテゴリに分けて検討してください:\n",
      "\n",
      "* ハーフスプレッド: ハーフスプレッドは取引強度と市場のボラティリティの関数です。取引強度に対して指数関数を使用することは、全範囲に対して適切ではないかもしれません。取引強度をハーフスプレッドに変換するためのより洗練されたアプローチを開発することができます。さらに、ここでは過去の取引強度と市場のボラティリティを使用していますが、短期的な取引強度とボラティリティを予測して、市場の状況の変化に迅速に対応することができます。これには、ニュース、イベント、流動性の真空などを使用してボラティリティの爆発を予測する戦略が含まれるかもしれません。\n",
      "\n",
      "\n",
      "* スキュー: スキューも取引強度と市場のボラティリティの関数です。このモデルでは在庫リスクのみが考慮されていますが、複数の市場を作成する際には他のリスクも考慮することができます。BARRAは他のリスクを同様に管理する良い例です。\n",
      "\n",
      "\n",
      "* 公正価格の設定: このモデルでは公正価格がミッドプライスと等しいとされていますが、マイクロプライスや関連資産を通じた公正価格の設定などの予測を組み込むことで、戦略を強化することができます。\n",
      "\n",
      "\n",
      "* ヘッジ: 複数の市場を作成する際には、ヘッジはリスク管理のための貴重なツールです。\n",
      "\n",
      "今後の例では、いくつかのトピックについてさらに詳しく説明します。"
    ]
  },
  {
    "index": 51,
    "source": [
      "## 参考文献\n",
      "[Dealing with the Inventory Risk - A solution to the market making problem](https://arxiv.org/abs/1105.3115)  \n",
      "[Optimal market making](https://arxiv.org/abs/1605.01862)  \n",
      "\n",
      "Knight Capital Group  \n",
      "[Stochastic Control Theory and High Frequency Trading](https://ieor.columbia.edu/files/seasdepts/industrial-engineering-operations-research/pdf-files/Borden_D_FESeminar_Sp10.pdf)  \n",
      "\n",
      "BitMEX Market Making Series  \n",
      "[Algo Trading & Market Making](https://blog.bitmex.com/wp-content/uploads/2019/11/Algo-Trading-and-Market-Making.pdf)  \n",
      "[How to Market Make Bitcoin Derivatives Lesson 1](https://blog.bitmex.com/how-to-market-make-bitcoin-derivatives-lesson-1/)  \n",
      "[How to Market Make Bitcoin Derivatives Lesson 2](https://blog.bitmex.com/how-to-market-make-bitcoin-derivatives-lesson-2/)  "
    ]
  }
]
